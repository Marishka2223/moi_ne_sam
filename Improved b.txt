<?php

// Подключение необходимых классов
require 'vendor/autoload.php';

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Models\Bb;

// Маршруты
Route::get('/user', function () {
    // Здесь можно добавить логику для отображения подписок пользователя
    return 'Страница пользователя с подписками';
})->name('user.subscriptions');

Route::get('/upgrade-plan/{id}', function ($id) {
    // Получаем текущую подписку
    $subscription = Bb::findOrFail($id);

    // Определяем доступные варианты улучшения
    $availablePlans = [];
    if ($subscription->price == 3) {
        $availablePlans = [
            ['title' => 'Duck+', 'price' => 6],
            ['title' => 'Duck PREMIUM', 'price' => 12],
        ];
    } elseif ($subscription->price == 6) {
        $availablePlans = [
            ['title' => 'Duck PREMIUM', 'price' => 12],
        ];
    }

    // Возвращаем представление с использованием встроенной функции view()
    return view('upgrade-plan', [
        'subscription' => $subscription,
        'availablePlans' => $availablePlans,
    ]);
})->name('upgrade.plan');

Route::post('/upgrade-plan/{id}', function (Request $request, $id) {
    // Валидация данных
    $request->validate([
        'title' => 'required|string|max:255',
        'price' => 'required|integer|in:6,12',
    ]);

    // Обновляем подписку
    $subscription = Bb::findOrFail($id);
    $subscription->update([
        'title' => $request->title,
        'price' => $request->price,
        'status' => 'Активно',
    ]);

    return redirect()->route('user.subscriptions')->with('success', 'План успешно улучшен!');
})->name('upgrade.plan.submit');

// Запуск маршрутов
$request = Request::capture();
$response = Route::dispatch($request);
$response->send();

?>
