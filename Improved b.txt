<?php

// Подключение необходимых классов
require 'vendor/autoload.php';

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Models\Bb;

// Имитация Laravel Router
Route::get('/upgrade-plan/{id}', function ($id) {
    // Получаем текущую подписку
    $subscription = Bb::findOrFail($id);

    // Определяем доступные варианты улучшения
    $availablePlans = [];
    if ($subscription->price == 3) {
        $availablePlans = [
            ['title' => 'Duck+', 'price' => 6],
            ['title' => 'Duck PREMIUM', 'price' => 12],
        ];
    } elseif ($subscription->price == 6) {
        $availablePlans = [
            ['title' => 'Duck PREMIUM', 'price' => 12],
        ];
    }

    // Возвращаем представление
    return <<<HTML
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Улучшение плана</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .subscription-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .subscription-column {
            border: 2px solid #ccc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
        }
        .subscription-column button {
            background-color: #ffa500;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .subscription-column button:hover {
            background-color: rgb(245, 188, 82);
        }
    </style>
</head>
<body>
<div style="display: flex; flex-direction: column;">
    <h1 style="display: flex; justify-content: center; font-size: 3em;">Улучшение плана</h1>
    <br><br><br>

    <div class="subscription-container">
        @foreach($availablePlans as $plan)
            <div class="subscription-column">
                <h2>{$plan['title']}</h2>
                <p>Срок: {$plan['price']} месяцев</p>
                <form action="/upgrade-plan/{$subscription->id}" method="POST">
                    <input type="hidden" name="_token" value="{$_SESSION['_token']}">
                    <input type="hidden" name="title" value="{$plan['title']}">
                    <input type="hidden" name="price" value="{$plan['price']}">
                    <button type="submit">Выбрать</button>
                </form>
            </div>
        @endforeach
    </div>
</div>
</body>
</html>
HTML;
});

Route::post('/upgrade-plan/{id}', function (Request $request, $id) {
    // Валидация данных
    $request->validate([
        'title' => 'required|string|max:255',
        'price' => 'required|integer|in:6,12',
    ]);

    // Обновляем подписку
    $subscription = Bb::findOrFail($id);
    $subscription->update([
        'title' => $request->title,
        'price' => $request->price,
        'status' => 'Активно',
    ]);

    // Перенаправляем пользователя
    header('Location: /user');
    exit;
});

// Запуск маршрутизатора
$request = Request::capture();
$response = Route::dispatch($request);
$response->send();
