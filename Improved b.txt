<?php
session_start();

// Подключение к базе данных
$mysqli = new mysqli("localhost", "root", "root", "modulez");

// Проверка соединения
if ($mysqli->connect_error) {
    die("Ошибка подключения: " . $mysqli->connect_error);
}

// Проверка, авторизован ли пользователь
if (!isset($_SESSION['modulez'])) {
    die("Пользователь не авторизован.");
}

// Получаем идентификатор пользователя из сессии
$user_id = $_SESSION['modulez']; // Предположим, что в сессии хранится id пользователя

// Получаем email пользователя из таблицы users
$stmt = $mysqli->prepare("SELECT email FROM users WHERE id = ?");
$stmt->bind_param("i", $user_id);
$stmt->execute();
$stmt->bind_result($email);
$stmt->fetch();
$stmt->close();

if (empty($email)) {
    die("Ошибка: Пользователь не найден.");
}

// Обработка формы
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $name = $_POST['name'];
    $content = $_POST['content'];
    $rate = $_POST['rate'];
    $status = $_POST['status'];
    $datez = $_POST['datez'];
    $category_name = $_POST['category_name'];

    // Обработка загрузки изображения
    if (isset($_FILES['image']) && $_FILES['image']['error'] == 0) {
        $image = $_FILES['image'];
        $image_size = $image['size'];

        if ($image_size > 2 * 1024 * 1024) {
            die("Ошибка: Размер изображения не должен превышать 2 МБ.");
        }

        $image_data = file_get_contents($image['tmp_name']);
    } else {
        die("Ошибка: Изображение не загружено.");
    }

    // Подготовка и выполнение SQL запроса
    $stmt = $mysqli->prepare("INSERT INTO goods (name, content, image, rate, status, datez, id_users, email_users, category_name) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
    $stmt->bind_param("ssbsssiss", $name, $content, $image_data, $rate, $status, $datez, $user_id, $email, $category_name);

    if ($stmt->execute()) {
        echo "Данные успешно добавлены.";
    } else {
        echo "Ошибка: " . $stmt->error;
    }

    $stmt->close();
}

// Получение списка категорий
$categories = $mysqli->query("SELECT name FROM category");
?>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Добавление товара</title>
</head>
<body>
    <h1>Добавление товара</h1>
    <form method="post" enctype="multipart/form-data">
        <label for="name">Название:</label>
        <input type="text" id="name" name="name" required><br><br>

        <label for="content">Описание:</label>
        <textarea id="content" name="content" required></textarea><br><br>

        <label for="image">Изображение:</label>
        <input type="file" id="image" name="image" required><br><br>

        <label for="rate">Подробности:</label>
        <input type="text" id="rate" name="rate" required><br><br>

        <label for="status">Статус:</label>
        <input type="text" id="status" name="status" required><br><br>

        <label for="datez">Дата:</label>
        <input type="date" id="datez" name="datez" required><br><br>

        <label for="category_name">Категория:</label>
        <select id="category_name" name="category_name" required>
            <?php while ($row = $categories->fetch_assoc()): ?>
                <option value="<?php echo $row['name']; ?>"><?php echo $row['name']; ?></option>
            <?php endwhile; ?>
        </select><br><br>

        <input type="submit" value="Добавить товар">
    </form>
</body>
</html>

<?php
$mysqli->close();
?>
